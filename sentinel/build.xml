<!-- Copyright ScenPro, Inc. 2005
     $Header: /share/content/gforge/sentinel/sentinel/build.xml,v 1.30 2007-05-14 14:30:29 hebell Exp $
     $Name: not supported by cvs2svn $
-->
<project name="caDSR Sentinel Alert Tool" default="init" basedir=".">
    <description>
        Build and deploy the caDSR Sentinel Alert Tool
    </description>
    <!-- set global properties for this build -->

    <property name="temp" location="tmp"/>
    <property name="oroot" location="${temp}/cadsrsentinel"/>
    <property name="test-results" location="test_results"/>

    <property name="ospackage" location="${temp}/ospack"/>
    <property name="ojsp" location="${oroot}/jsp"/>
    <property name="odoc" location="${oroot}/doc"/>
    <property name="owebinf" location="${oroot}/WEB-INF"/>
    <property name="oclasses" location="${owebinf}/classes"/>
    <property name="orootC2" location="${oclasses}/gov"/>
    <property name="orootC3" location="${oclasses}/gov/nih"/>
    <property name="orootC3B" location="${oclasses}/gov/nih/nci"/>
    <property name="orootC3C" location="${oclasses}/gov/nih/nci/cadsr"/>
    <property name="orootC4" location="${oclasses}/gov/nih/nci/cadsr/sentinel"/>
    <property name="olib" location="${owebinf}/lib"/>
    <property name="otld" location="${owebinf}/tld"/>
    <property name="owar" location="distrib/war"/>
    <property name="java" location="src"/>
    <property name="xml" location="conf/web"/>
    <property name="tld" location="conf/web/tld"/>
    <property name="lib" location="lib"/>
    <property name="jsp" location="ui"/>
    <property name="prop" location="."/>
    <property environment="environ"/>
    
    <target name="clean">
     	<delete dir="${oroot}"/>
    	<mkdir dir="${temp}"/>
    	<mkdir dir="${test-results}"/>
    	<mkdir dir="${oroot}"/>
    	<mkdir dir="${ojsp}"/>
    	<mkdir dir="${owebinf}"/>
    	<mkdir dir="${oclasses}"/>
    	<mkdir dir="${orootC2}"/>
    	<mkdir dir="${orootC3}"/>
    	<mkdir dir="${orootC4}"/>
        <mkdir dir="${orootC4}/test"/>
        <mkdir dir="${orootC4}/tool"/>
        <mkdir dir="${orootC4}/util"/>
        <mkdir dir="${orootC4}/database"/>
        <mkdir dir="${orootC4}/ui"/>
        <mkdir dir="${orootC4}/audits"/>
    	<mkdir dir="${olib}"/>
    	<mkdir dir="${otld}"/>
        <mkdir dir="${owar}"/>
    </target>
 
    <target name="setup" depends="clean">
        <copy todir="${olib}">
            <fileset file="${lib}/antlr.jar"/>
            <fileset file="${lib}/commons-beanutils-1.7.0.jar"/>
            <fileset file="${lib}/commons-chain-1.1.jar"/>
            <fileset file="${lib}/commons-digester-1.6.jar"/>
            <fileset file="${lib}/commons-fileupload-1.1.1.jar"/>
            <fileset file="${lib}/commons-logging-1.1.jar"/>
            <fileset file="${lib}/commons-validator-1.3.0.jar"/>
            <fileset file="${lib}/struts-config_1_3.dtd"/>
            <fileset file="${lib}/struts-core-1.3.5.jar" />
            <fileset file="${lib}/struts-taglib-1.3.5.jar"/>
            <fileset file="${lib}/tiles-config_1_3.dtd"/>
            <fileset file="${lib}/validator-rules.xml"/>
        </copy>
        <copy todir="${otld}">
            <fileset dir="${tld}"/>
        </copy>
        <copy todir="${ojsp}">
            <fileset dir="${jsp}/css"/>
            <fileset dir="${jsp}/jsp"/>
            <fileset dir="${jsp}/html"/>
            <fileset dir="${jsp}/scripts"/>
            <fileset dir="${jsp}/images"/>
        </copy>
        <copy todir="${owebinf}">
            <fileset file="${xml}/struts-config.xml"/>
        </copy>
        <filter filtersfile="${conf}/DSRAlertDeploy.properties"/>
        <delete>
            <fileset file="${orootC4}/DSRAlert.properties"/>
            <fileset file="${orootC4}/test/DSRAlertTest.properties"/>
        </delete>
        <copy tofile="${orootC4}/DSRAlert.properties" filtering="true">
            <fileset file="conf/common/DSRAlert.properties"/>
        </copy>
        <copy tofile="${orootC4}/test/DSRAlertTest.properties">
            <fileset file="${conf}/DSRAlertTest.properties"/>
        </copy>
    	<copy todir="${owebinf}">
            <fileset file="${xml}/web.xml"/>
        </copy>
    </target>

    <path id="libpath">
    <!-- 
            <fileset file="${lib}/activation.jar"/>
            <fileset file="${lib}/antlr.jar"/>
            <fileset file="${lib}/jakarta-oro.jar"/>
            <fileset file="${lib}/nls_charset12.jar"/>
            -->
            <fileset file="${lib}/ant.jar"/>
            <fileset file="${lib}/asm.jar"/>
            <fileset file="${lib}/cacore32-client.jar"/>
            <fileset file="${lib}/cglib-2.1.3.jar"/>
            <fileset file="${lib}/hibernate3.jar"/>
            <fileset file="${lib}/j2ee.jar"/>
            <fileset file="${lib}/jakarta-oro.jar"/>
            <fileset file="${lib}/jasper-compiler.jar"/>
            <fileset file="${lib}/jasper-runtime.jar"/>
            <fileset file="${lib}/jboss-system.jar"/>
            <fileset file="${lib}/log4j-1.2.13.jar"/>
            <fileset file="${lib}/mail.jar"/>
            <fileset file="${lib}/ojdbc14.jar"/>
            <fileset file="${lib}/spring.jar"/>
            <fileset file="${lib}/test/junit-4.1.jar"/>
            <fileset file="${lib}/test/strutstest-2.1.3.1.jar"/>
            <fileset dir="${olib}">
                <include name="**/*.jar"/>
            </fileset>
    </path>

    <target name="build" depends="setup">
        <javac srcdir="${java}" destdir="${oclasses}" tempdir="${temp}" debug="${jdebug}">
            <compilerarg line="-deprecation"/>
            <compilerarg line="-Xlint:unchecked"/>
            <classpath refid="libpath" />
        </javac>
        <jspc srcdir="${ojsp}" destdir="${oclasses}" compiler="jasper41">
            <classpath refid="libpath" />
            <include name="**/*.jsp" />
        </jspc>
        <javac srcdir="${oclasses}/jsp" destdir="${oclasses}" encoding="Cp1252">
            <classpath refid="libpath" />
            <include name="**/*.java" />
        </javac>
        <delete dir="${oclasses}/jsp"/>
        <delete dir="${oclasses}/org"/>
        <delete file="${owar}/cadsrsentinel.jar"/>
        <delete file="${owar}/cadsrsentinelapi.jar"/>
        <cvs command="status -v" output="${oclasses}/cvsdeploy.txt"/>
        <jar destfile="${owar}/cadsrsentinel.jar">
            <fileset dir="${oclasses}">
                <include name="cvsdeploy.txt" />
                <include name="gov/nih/nci/cadsr/sentinel/*.properties" />
                <include name="gov/nih/nci/cadsr/sentinel/tool/*.class" />
                <include name="gov/nih/nci/cadsr/sentinel/test/*.class" />
                <include name="gov/nih/nci/cadsr/sentinel/database/*.class" />
                <include name="gov/nih/nci/cadsr/sentinel/audits/*.class" />
            </fileset>
        </jar>
        <jar destfile="${owar}/cadsrsentinelapi.jar">
            <fileset dir="${oclasses}">
                <include name="cvsdeploy.txt" />
                <include name="gov/nih/nci/cadsr/sentinel/*.properties" />
                <include name="gov/nih/nci/cadsr/sentinel/util/*.class" />
            </fileset>
        </jar>
        <delete file="${oclasses}/cvsdeploy.txt"/>
    </target>

	<target name="test" unless="notest">
        <delete><fileset dir="${test-results}" includes="**/*"/></delete>
        <junit printsummary="on" haltonfailure="yes" showoutput="yes" filtertrace="off">
            <classpath>
                <pathelement location="${oroot}"/>
                <pathelement location="${oclasses}"/>
                <fileset dir="${lib}">
                    <include name="**/*.jar"/>
                </fileset>
            </classpath>
            <sysproperty key="test_propfile" value="${conf}/DSRAlertTest.properties"/>
            <sysproperty key="property_xml" value="/development/sentinel/${conf}/cadsrsentinel.xml"/>
            <formatter type="plain"/>
            <batchtest fork="yes" todir="${test-results}" filtertrace="off">
                <fileset dir="${java}">
                    <include name="**/test/TestDatabase.java"/>
                </fileset>
            </batchtest>
        </junit>
    	<junit printsummary="on" haltonfailure="yes" showoutput="yes" filtertrace="off">
    		<classpath>
    			<pathelement location="${oroot}"/>
  		      	<pathelement location="${oclasses}"/>
    		    <fileset dir="${lib}">
    		        <include name="**/*.jar"/>
    		    </fileset>
    		</classpath>
    		<sysproperty key="test_propfile" value="${conf}/DSRAlertTest.properties"/>
            <sysproperty key="property_xml" value="/development/sentinel/${conf}/cadsrsentinel.xml"/>
    	  	<formatter type="plain"/>
    	  	<batchtest fork="yes" todir="${test-results}" filtertrace="off">
    	    	<fileset dir="${java}">
    	      		<include name="**/test/Test*.java"/>
    	    	</fileset>
    	  	</batchtest>
    	</junit>
	</target>

    <target name="deploy" depends="build,test">
        <delete file="${owar}/cadsrsentinel.war"/>
        <cvs command="status -v" output="${ojsp}/cvsdeploy.txt"/>
        <war destfile="${owar}/cadsrsentinel.war" basedir="${oroot}" update="true" webxml="${xml}/web.xml">
        </war>
    </target>

    <target name="ospack">
        <delete dir="${ospackage}"/>
        <mkdir dir="${ospackage}"/>
        <copy todir="${ospackage}">
            <fileset file="build.xml"/>
        </copy>
        <mkdir dir="${ospackage}/conf"/>
        <mkdir dir="${ospackage}/conf/common"/>
        <copy todir="${ospackage}/conf/common">
            <fileset dir="conf/common"/>
        </copy>
        <mkdir dir="${ospackage}/conf/web"/>
        <copy todir="${ospackage}/conf/web">
            <fileset dir="conf/web"/>
        </copy>
        <copy todir="${ospackage}/conf/web" overwrite="true">
            <fileset dir="conf/osiweb"/>
        </copy>
        <mkdir dir="${ospackage}/conf/prod"/>
        <copy todir="${ospackage}/conf/prod">
            <fileset dir="conf/osi"/>
        </copy>
        <mkdir dir="${ospackage}/conf/stage"/>
        <copy todir="${ospackage}/conf/stage">
            <fileset dir="conf/osi"/>
        </copy>
        <mkdir dir="${ospackage}/conf/qa"/>
        <copy todir="${ospackage}/conf/qa">
            <fileset dir="conf/osi"/>
        </copy>
        <mkdir dir="${ospackage}/conf/dev"/>
        <copy todir="${ospackage}/conf/dev">
            <fileset dir="conf/osi"/>
        </copy>
        <mkdir dir="${ospackage}/conf/proto"/>
        <copy todir="${ospackage}/conf/proto">
            <fileset dir="conf/osi"/>
        </copy>
        <mkdir dir="${ospackage}/distrib"/>
        <copy todir="${ospackage}/distrib">
            <fileset dir="distrib"/>
        </copy>
        <delete dir="${ospackage}/distrib/war"/>
        <mkdir dir="${ospackage}/doc"/>
        <copy todir="${ospackage}/doc">
            <fileset dir="doc"/>
        </copy>
        <mkdir dir="${ospackage}/lib"/>
        <copy todir="${ospackage}/lib">
            <fileset dir="lib"/>
        </copy>
        <mkdir dir="${ospackage}/src"/>
        <copy todir="${ospackage}/src">
            <fileset dir="src"/>
        </copy>
        <mkdir dir="${ospackage}/ui"/>
        <copy todir="${ospackage}/ui">
            <fileset dir="ui"/>
        </copy>
        <zip destfile="${owar}/sentinel_ospack.zip">
            <zipfileset dir="${ospackage}"/>
        </zip>
    </target>

    <target name="build-doc">
        <mkdir dir="${temp}"/>
        <mkdir dir="${oroot}"/>
        <delete dir="${odoc}"/>
        <mkdir dir="${odoc}"/>
        <javadoc
                destdir="${odoc}"
                Private="true"
                author="true"
                version="true"
                use="true"
                windowtitle="caDSR Sentinel Tool API">
			
            <classpath>
                <fileset dir="${lib}">
                    <include name="**/*.jar" />
                </fileset>
            </classpath>
			
            <packageset dir="${java}" defaultexcludes="yes">
                <include name="gov/nih/nci/cadsr/sentinel/**" />
            </packageset>
			
            <doctitle><![CDATA[<h1>caDSR Sentinel Tool</h1>]]></doctitle>
			<bottom><![CDATA[<i>Copyright &#169; 2005 ScenPro, Inc. All Rights Reserved.</i>]]></bottom>
			<tag name="todo" scope="all" description="To do:" />
			<group title="Source Package" packages="gov.nih.nci.cadsr.sentinel.tool;gov.nih.nci.cadsr.sentinel.tool.Test"/>
			<link offline="true" href="http://java.sun.com/products/jdk/1.2/docs/api/" packagelistLoc="D:\temp"/>
        </javadoc>
        <zip destfile="${owar}/sentinel_doc.zip">
            <zipfileset dir="tmp/cadsrsentinel/doc"/>
        </zip>
    </target>

    <target name="init">
        <echo message="This build script must be run with the name of the desired target: build-proto, build-dev, build-qa, build-stage, build-prod, build-doc, build-ospackage."/>
    </target>

    <target name="build-proto">
        <antcall target="deploy">
            <param name="conf" value="conf/proto"/>
            <param name="jdebug" value="on"/>
        </antcall>
    </target>

    <target name="build-local">
        <antcall target="deploy">
            <param name="conf" value="conf/local"/>
            <param name="jdebug" value="on"/>
        </antcall>
        <copy todir="${jbosshome}">
            <fileset file="${owar}/cadsrsentinel.war" />
        </copy>
    </target>

    <target name="build-dev">
        <antcall target="deploy">
            <param name="conf" value="conf/dev"/>
            <param name="jdebug" value="on"/>
        </antcall>
    </target>

    <target name="build-qa">
        <antcall target="deploy">
            <param name="conf" value="conf/qa"/>
            <param name="jdebug" value="on"/>
        </antcall>
    </target>

    <target name="build-stage">
        <antcall target="deploy">
            <param name="conf" value="conf/stage"/>
            <param name="jdebug" value="off"/>
        </antcall>
    </target>

    <target name="build-prod">
        <antcall target="deploy">
            <param name="conf" value="conf/prod"/>
            <param name="jdebug" value="off"/>
        </antcall>
    </target>

    <target name="build-ospackage">
        <antcall target="ospack">
        </antcall>
    </target>

</project>
